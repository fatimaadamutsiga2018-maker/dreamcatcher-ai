"use client";

import { useState, useEffect, useCallback, useMemo } from "react";
import EnergyTuner from "@/components/EnergyTuner";
import ResonanceCompass from "@/components/ResonanceCompass";
import AtomicCard from "@/components/AtomicCard";
import NebulaBackground from "@/components/NebulaBackground";
import { calculateGuestMode, calculateAnonymousMode, calculateMemberMode, calculateSeedSum, calculateBirthdaySum } from "@/lib/engine-v3";
import { USER_MODES, TWELVE_OFFICERS, calculateTwelveOfficer } from "@/lib/constants";
import { generateAmbientEnergyField } from "@/lib/ambient-energy";
import type { TriFactorResult } from "@/lib/engine-v3";

type CardData = {
  mode: keyof typeof USER_MODES;
  status: string;
  oracle: string;
  supported: string[];
  adjustment: string;
  disclaimer: string;
  hexagram?: {
    upper_trigram: number;
    lower_trigram: number;
    moving_position: number;
    upper_name: string;
    lower_name: string;
  };
  l2_interpretation?: {
    theme: string;
    resonance_pattern: string;
    bio_field_intensity: number;
    state_description: string;
    friction_point: string;
    strategic_recalibration: string[];
    optimal_window: string;
    execution_blueprint: string[];
  };
  timestamp?: number;
  seed?: string;
};

const STORAGE_KEY = 'dreamcatcher-recent-reading';
const STORAGE_VERSION = 'v1';

export default function Home() {
  const [cardOpen, setCardOpen] = useState(false);
  const [cardData, setCardData] = useState<CardData>({
    mode: "GUEST",
    status: "",
    oracle: "",
    supported: [],
    adjustment: "",
    disclaimer: "",
  });
  const [recentReading, setRecentReading] = useState<CardData | null>(null);
  const [currentDate] = useState(new Date());

  // User calibration state
  const [userCalibration, setUserCalibration] = useState<{
    calibrated: boolean;
    mode: keyof typeof USER_MODES;
    code?: string;
    birthday?: string;
    energyColor?: 'kinetic-green' | 'stillness-violet' | 'neutral';
    triFactorResult?: TriFactorResult;
  }>({
    calibrated: false,
    mode: "GUEST",
  });

  // Generate Ambient Energy Field data
  const ambientField = generateAmbientEnergyField(currentDate);
  const currentOfficerKey = calculateTwelveOfficer(currentDate);
  const currentOfficer = TWELVE_OFFICERS[currentOfficerKey];

  // Load recent reading on mount
  useEffect(() => {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        const data = JSON.parse(stored);
        if (data.version === STORAGE_VERSION) {
          setRecentReading(data.reading);
        }
      }
    } catch (error) {
      console.error('Failed to load recent reading:', error);
    }

    // Auto-trigger Guest Mode reading on mount
    try {
      const result = calculateGuestMode(currentDate);

      const newCardData: CardData = {
        mode: result.mode,
        status: result.l1_card.status,
        oracle: result.l1_card.oracle,
        supported: result.l1_card.supported,
        adjustment: result.l1_card.adjustment,
        disclaimer: result.l1_card.disclaimer,
        hexagram: {
          upper_trigram: result.hexagram.upper_trigram,
          lower_trigram: result.hexagram.lower_trigram,
          moving_position: result.hexagram.moving_position,
          upper_name: result.hexagram.upper_name,
          lower_name: result.hexagram.lower_name,
        },
        l2_interpretation: {
          theme: result.l2_interpretation.theme,
          resonance_pattern: result.l2_interpretation.resonance_pattern,
          bio_field_intensity: result.l2_interpretation.bio_field_intensity,
          state_description: result.l2_interpretation.state_description,
          friction_point: result.l2_interpretation.friction_point,
          strategic_recalibration: result.l2_interpretation.strategic_recalibration,
          optimal_window: result.l2_interpretation.optimal_window,
          execution_blueprint: result.l2_interpretation.execution_blueprint,
        },
        timestamp: result.timestamp,
        seed: `GUEST-${currentDate.toISOString()}`,
      };

      setCardData(newCardData);
      saveReading(newCardData);
    } catch (error) {
      console.error('Guest mode calculation failed:', error);
    }
  }, []);

  // Save reading to localStorage
  const saveReading = useCallback((data: CardData) => {
    try {
      const storageData = {
        version: STORAGE_VERSION,
        reading: {
          ...data,
          timestamp: Date.now(),
        },
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(storageData));
      setRecentReading(storageData.reading);
    } catch (error) {
      console.error('Failed to save reading:', error);
    }
  }, []);

  // Calculate personalized compatibility based on Global Vibe √ó User State interaction
  const personalizedCompatibility = useMemo(() => {
    console.log('üîÑ Calculating personalized compatibility...');
    console.log('  - userCalibration.calibrated:', userCalibration.calibrated);
    console.log('  - userCalibration.triFactorResult:', userCalibration.triFactorResult);

    if (!userCalibration.calibrated || !userCalibration.triFactorResult) {
      console.log('  ‚ö†Ô∏è Not calibrated, returning ambient compatibility');
      // Return ambient compatibility if not calibrated
      return ambientField.compatibility;
    }

    const triFactor = userCalibration.triFactorResult;
    const baseCompatibility = ambientField.compatibility;

    // Calculate resonance factor based on hexagram
    const upperTrigram = triFactor.hexagram.upper_trigram;
    const lowerTrigram = triFactor.hexagram.lower_trigram;
    const movingPosition = triFactor.hexagram.moving_position;

    // Trigram harmony (0-2: 2=perfect match, 0=clash)
    const trigramHarmony = upperTrigram === lowerTrigram ? 2 : 1;

    // Moving position influence (1-6: even numbers are more stable)
    const positionStability = movingPosition % 2 === 0 ? 1 : 0.5;

    // Bio-field intensity from L2 interpretation
    const bioIntensity = triFactor.l2_interpretation.bio_field_intensity / 100;

    // Calculate resonance multiplier (0.5 to 1.5)
    const resonanceMultiplier = 0.5 + (trigramHarmony * 0.3) + (positionStability * 0.2) + (bioIntensity * 0.5);

    // Note: Energy color is already set in userCalibration.state

    // Adjust each compatibility category
    const adjustStatus = (baseStatus: 'High' | 'Medium' | 'Low', resonance: number) => {
      if (resonance > 1.2) {
        return baseStatus === 'Low' ? 'Medium' : 'High';
      } else if (resonance < 0.8) {
        return baseStatus === 'High' ? 'Medium' : 'Low';
      }
      return baseStatus;
    };

    return {
      business: {
        status: adjustStatus(baseCompatibility.business.status, resonanceMultiplier * (upperTrigram % 2 === 0 ? 1.1 : 0.9)),
        note: baseCompatibility.business.note,
      },
      social: {
        status: adjustStatus(baseCompatibility.social.status, resonanceMultiplier * (lowerTrigram % 2 === 0 ? 1.1 : 0.9)),
        note: baseCompatibility.social.note,
      },
      strategic: {
        status: adjustStatus(baseCompatibility.strategic.status, resonanceMultiplier * (movingPosition <= 3 ? 1.1 : 0.9)),
        note: baseCompatibility.strategic.note,
      },
      action: {
        status: adjustStatus(baseCompatibility.action.status, resonanceMultiplier * bioIntensity),
        note: baseCompatibility.action.note,
      },
    };

    console.log('  ‚úÖ Personalized compatibility calculated:', {
      business: { status: result.business.status, original: baseCompatibility.business.status },
      social: { status: result.social.status, original: baseCompatibility.social.status },
      strategic: { status: result.strategic.status, original: baseCompatibility.strategic.status },
      action: { status: result.action.status, original: baseCompatibility.action.status },
    });

    return result;
  }, [userCalibration.calibrated, userCalibration.triFactorResult, ambientField.compatibility]);

  const handleTuned = (code: string, mode: keyof typeof USER_MODES, birthday?: string) => {
    try {
      let result: TriFactorResult;

      switch (mode) {
        case "GUEST":
          result = calculateGuestMode(new Date());
          break;
        case "ANONYMOUS":
          const seedSum = calculateSeedSum(code);
          result = calculateAnonymousMode(seedSum, new Date());
          break;
        case "MEMBER":
          const birthdaySum = birthday ? calculateBirthdaySum(birthday) : calculateSeedSum(code);
          const intentSum = code ? calculateSeedSum(code) : undefined;
          result = calculateMemberMode(birthdaySum, intentSum, new Date());
          break;
        default:
          result = calculateAnonymousMode(calculateSeedSum(code || "123"), new Date());
      }

      const newCardData: CardData = {
        mode: result.mode,
        status: result.l1_card.status,
        oracle: result.l1_card.oracle,
        supported: result.l1_card.supported,
        adjustment: result.l1_card.adjustment,
        disclaimer: result.l1_card.disclaimer,
        hexagram: {
          upper_trigram: result.hexagram.upper_trigram,
          lower_trigram: result.hexagram.lower_trigram,
          moving_position: result.hexagram.moving_position,
          upper_name: result.hexagram.upper_name,
          lower_name: result.hexagram.lower_name,
        },
        l2_interpretation: {
          theme: result.l2_interpretation.theme,
          resonance_pattern: result.l2_interpretation.resonance_pattern,
          bio_field_intensity: result.l2_interpretation.bio_field_intensity,
          state_description: result.l2_interpretation.state_description,
          friction_point: result.l2_interpretation.friction_point,
          strategic_recalibration: result.l2_interpretation.strategic_recalibration,
          optimal_window: result.l2_interpretation.optimal_window,
          execution_blueprint: result.l2_interpretation.execution_blueprint,
        },
        timestamp: result.timestamp,
        seed: code || `${mode}-${new Date().toISOString()}`,
      };

      setCardData(newCardData);
      saveReading(newCardData);
      setCardOpen(true);

      // Store tri-factor result for calibration
      setUserCalibration({
        calibrated: true,
        mode: mode,
        code: code,
        birthday: birthday,
        triFactorResult: result,
      });
    } catch (error) {
      console.error('Tri-factor resonance calculation failed:', error);
    }
  };

  // Handle calibration from Resonance Compass
  const handleCalibrated = useCallback((code: string, mode: keyof typeof USER_MODES, birthday?: string) => {
    console.log('üéØ handleCalibrated called:', { code, mode, birthday });
    try {
      let result: TriFactorResult;

      switch (mode) {
        case "ANONYMOUS":
          const seedSum = calculateSeedSum(code);
          result = calculateAnonymousMode(seedSum, new Date());
          break;
        case "MEMBER":
          const birthdaySum = birthday ? calculateBirthdaySum(birthday) : calculateSeedSum(code);
          const intentSum = code ? calculateSeedSum(code) : undefined;
          result = calculateMemberMode(birthdaySum, intentSum, new Date());
          break;
        default:
          result = calculateAnonymousMode(calculateSeedSum(code || "123"), new Date());
      }

      console.log('üìä Tri-factor result:', result);

      // Calculate energy color based on tri-factor result
      const upperTrigram = result.hexagram.upper_trigram;
      const lowerTrigram = result.hexagram.lower_trigram;
      const movingPosition = result.hexagram.moving_position;
      const bioIntensity = result.l2_interpretation.bio_field_intensity;

      const trigramHarmony = upperTrigram === lowerTrigram ? 2 : 1;
      const positionStability = movingPosition % 2 === 0 ? 1 : 0.5;

      let energyColor: 'kinetic-green' | 'stillness-violet' | 'neutral';
      if (bioIntensity > 70 && trigramHarmony >= 1) {
        energyColor = 'kinetic-green';
      } else if (bioIntensity < 50 || positionStability < 1) {
        energyColor = 'stillness-violet';
      } else {
        energyColor = 'neutral';
      }

      console.log('‚ú® Energy color:', energyColor);

      // Store calibration state
      const newCalibration = {
        calibrated: true,
        mode: mode,
        code: code,
        birthday: birthday,
        energyColor: energyColor,
        triFactorResult: result,
      };

      console.log('üîê Setting user calibration:', newCalibration);
      setUserCalibration(newCalibration);

      // Force a re-render by updating card data
      const newCardData: CardData = {
        mode: result.mode,
        status: result.l1_card.status,
        oracle: result.l1_card.oracle,
        supported: result.l1_card.supported,
        adjustment: result.l1_card.adjustment,
        disclaimer: result.l1_card.disclaimer,
        hexagram: {
          upper_trigram: result.hexagram.upper_trigram,
          lower_trigram: result.hexagram.lower_trigram,
          moving_position: result.hexagram.moving_position,
          upper_name: result.hexagram.upper_name,
          lower_name: result.hexagram.lower_name,
        },
        l2_interpretation: {
          theme: result.l2_interpretation.theme,
          resonance_pattern: result.l2_interpretation.resonance_pattern,
          bio_field_intensity: result.l2_interpretation.bio_field_intensity,
          state_description: result.l2_interpretation.state_description,
          friction_point: result.l2_interpretation.friction_point,
          strategic_recalibration: result.l2_interpretation.strategic_recalibration,
          optimal_window: result.l2_interpretation.optimal_window,
          execution_blueprint: result.l2_interpretation.execution_blueprint,
        },
        timestamp: result.timestamp,
        seed: code || `${mode}-${new Date().toISOString()}`,
      };

      setCardData(newCardData);
      saveReading(newCardData);

      // Open the detailed reading card
      setCardOpen(true);

      console.log('‚úÖ Calibration complete, card data updated, opening modal');
    } catch (error) {
      console.error('‚ùå Calibration failed:', error);
    }
  }, [saveReading]);

  const handleViewRecent = () => {
    if (recentReading) {
      setCardData(recentReading);
      setCardOpen(true);
    }
  };

  return (
    <div className="relative min-h-screen w-full overflow-hidden bg-black">
      {/* Nebula/Vortex animated background */}
      <NebulaBackground date={currentDate} />

      {/* Main content - Unified Briefing Layout */}
      <main className="relative z-10 mx-auto flex min-h-screen w-full max-w-3xl flex-col justify-between px-4 py-6">
        {/* UNIFIED BRIEFING CONTAINER */}
        <div className="w-full">
          {/* Unified Glass Container */}
          <div className="backdrop-blur-xl bg-white/5 border border-white/10 rounded-2xl p-5 shadow-2xl mb-4">
            {/* Section 1: Header - Date + Label + Officer Badge */}
            <div className="text-center mb-4">
              <div className="text-[10px] font-bold uppercase tracking-[0.35em] text-white/40 mb-2">
                {ambientField.anchor.label}
              </div>
              <h1 className="text-3xl md:text-4xl font-bold text-white tracking-wide mb-2">
                {ambientField.anchor.date}
              </h1>
              <div className={`inline-block px-3 py-1 rounded-full ${
                currentOfficer.color_type === 'expanding'
                  ? 'bg-emerald-500/20 border border-emerald-500/40'
                  : 'bg-indigo-500/20 border border-indigo-500/40'
              }`}>
                <span className={`text-xs font-semibold ${
                  currentOfficer.color_type === 'expanding' ? 'text-emerald-300' : 'text-indigo-300'
                }`}>
                  {ambientField.anchor.officer}
                </span>
              </div>
            </div>

            {/* Section 2: Narrative - Environmental Summary */}
            <div className="mb-4">
              <p className="text-sm text-white/90 text-center leading-relaxed">
                {ambientField.narrative.sentence1} {ambientField.narrative.sentence2}
              </p>
            </div>

            {/* Section 3: Metrics - Compact Progress Bars */}
            <div className="grid grid-cols-3 gap-3 mb-4">
              {/* Clarity */}
              <div className="text-center">
                <div className="text-[9px] font-bold uppercase tracking-[0.15em] text-white/40 mb-1">
                  Clarity
                </div>
                <div className="relative h-1.5 bg-white/10 rounded-full overflow-hidden mb-1">
                  <div
                    className="h-full bg-gradient-to-r from-cyan-400 to-emerald-400 transition-all duration-700"
                    style={{ width: `${ambientField.metrics.clarity}%` }}
                  />
                </div>
                <div className="text-lg font-bold text-white">
                  {ambientField.metrics.clarity}%
                </div>
              </div>

              {/* Friction */}
              <div className="text-center">
                <div className="text-[9px] font-bold uppercase tracking-[0.15em] text-white/40 mb-1">
                  Friction
                </div>
                <div className="relative h-1.5 bg-white/10 rounded-full overflow-hidden mb-1">
                  <div
                    className={`h-full transition-all duration-700 ${
                      ambientField.metrics.friction < 40
                        ? 'bg-gradient-to-r from-green-400 to-emerald-400'
                        : ambientField.metrics.friction < 70
                        ? 'bg-gradient-to-r from-yellow-400 to-amber-400'
                        : 'bg-gradient-to-r from-orange-400 to-red-400'
                    }`}
                    style={{ width: `${ambientField.metrics.friction}%` }}
                  />
                </div>
                <div className="text-lg font-bold text-white">
                  {ambientField.metrics.friction}%
                </div>
              </div>

              {/* Flow */}
              <div className="text-center">
                <div className="text-[9px] font-bold uppercase tracking-[0.15em] text-white/40 mb-1">
                  Flow
                </div>
                <div className="relative h-1.5 bg-white/10 rounded-full overflow-hidden mb-1">
                  <div
                    className="h-full bg-gradient-to-r from-violet-400 to-purple-400 transition-all duration-700"
                    style={{ width: `${ambientField.metrics.flow}%` }}
                  />
                </div>
                <div className="text-lg font-bold text-white">
                  {ambientField.metrics.flow}%
                </div>
              </div>
            </div>

            {/* Section 4: Vertical Strategy List */}
            <div>
              <div className="text-[9px] font-bold uppercase tracking-[0.2em] text-white/40 mb-3 text-center">
                {userCalibration.calibrated ? (
                  <span className="text-emerald-300">
                    INTEGRATED STRATEGY ‚óè Calibrated
                  </span>
                ) : (
                  'SYSTEM COMPATIBILITY'
                )}
              </div>

              <div className="space-y-2">
                {/* Business */}
                <div className={`flex items-center gap-3 px-4 py-3 rounded-xl border transition-all duration-300 ${
                  (() => {
                    const comp = personalizedCompatibility.business;
                    const baseStyle = comp.status === 'High'
                      ? 'bg-emerald-500/10 border-emerald-500/30'
                      : comp.status === 'Medium'
                      ? 'bg-amber-500/10 border-amber-500/30'
                      : 'bg-white/5 border-white/10';

                    if (userCalibration.calibrated && userCalibration.energyColor && comp.status === 'High') {
                      if (userCalibration.energyColor === 'kinetic-green') {
                        return 'bg-gradient-to-r from-cyan-500/15 to-emerald-500/15 border border-cyan-400/50 shadow-[0_0_20px_rgba(34,211,238,0.25)]';
                      } else if (userCalibration.energyColor === 'stillness-violet') {
                        return 'bg-gradient-to-r from-violet-500/15 to-purple-500/15 border border-violet-400/50 shadow-[0_0_20px_rgba(139,92,246,0.25)]';
                      }
                    }
                    return baseStyle;
                  })()
                }`}>
                  {/* Icon */}
                  <div className="flex-shrink-0">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold ${
                      (() => {
                        const comp = personalizedCompatibility.business;
                        if (userCalibration.calibrated && userCalibration.energyColor === 'kinetic-green' && comp.status === 'High') {
                          return 'bg-cyan-500/40 text-cyan-200';
                        } else if (userCalibration.calibrated && userCalibration.energyColor === 'stillness-violet' && comp.status === 'High') {
                          return 'bg-violet-500/40 text-violet-200';
                        } else if (comp.status === 'High') {
                          return 'bg-emerald-500/30 text-emerald-300';
                        } else if (comp.status === 'Medium') {
                          return 'bg-amber-500/30 text-amber-300';
                        } else {
                          return 'bg-white/10 text-white/50';
                        }
                      })()
                    }`}>
                      üíº
                    </div>
                  </div>

                  {/* Content */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-0.5">
                      <div className="text-[10px] font-bold uppercase tracking-[0.15em] text-white/50">
                        Business
                      </div>
                      <div className={`text-[10px] font-bold px-2 py-0.5 rounded ${
                        (() => {
                          const comp = personalizedCompatibility.business;
                          if (userCalibration.calibrated && userCalibration.energyColor === 'kinetic-green' && comp.status === 'High') {
                            return 'bg-cyan-500/40 text-cyan-200';
                          } else if (userCalibration.calibrated && userCalibration.energyColor === 'stillness-violet' && comp.status === 'High') {
                            return 'bg-violet-500/40 text-violet-200';
                          } else if (comp.status === 'High') {
                            return 'bg-emerald-500/30 text-emerald-300';
                          } else if (comp.status === 'Medium') {
                            return 'bg-amber-500/30 text-amber-300';
                          } else {
                            return 'bg-white/10 text-white/50';
                          }
                        })()
                      }`}>
                        {personalizedCompatibility.business.status}
                      </div>
                    </div>
                    <p className="text-xs text-white/80 leading-snug">
                      {personalizedCompatibility.business.note}
                    </p>
                  </div>
                </div>

                {/* Social */}
                <div className={`flex items-center gap-3 px-4 py-3 rounded-xl border transition-all duration-300 ${
                  (() => {
                    const comp = personalizedCompatibility.social;
                    const baseStyle = comp.status === 'High'
                      ? 'bg-emerald-500/10 border-emerald-500/30'
                      : comp.status === 'Medium'
                      ? 'bg-amber-500/10 border-amber-500/30'
                      : 'bg-white/5 border-white/10';

                    if (userCalibration.calibrated && userCalibration.energyColor && comp.status === 'High') {
                      if (userCalibration.energyColor === 'kinetic-green') {
                        return 'bg-gradient-to-r from-cyan-500/15 to-emerald-500/15 border border-cyan-400/50 shadow-[0_0_20px_rgba(34,211,238,0.25)]';
                      } else if (userCalibration.energyColor === 'stillness-violet') {
                        return 'bg-gradient-to-r from-violet-500/15 to-purple-500/15 border border-violet-400/50 shadow-[0_0_20px_rgba(139,92,246,0.25)]';
                      }
                    }
                    return baseStyle;
                  })()
                }`}>
                  <div className="flex-shrink-0">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold ${
                      (() => {
                        const comp = personalizedCompatibility.social;
                        if (userCalibration.calibrated && userCalibration.energyColor === 'kinetic-green' && comp.status === 'High') {
                          return 'bg-cyan-500/40 text-cyan-200';
                        } else if (userCalibration.calibrated && userCalibration.energyColor === 'stillness-violet' && comp.status === 'High') {
                          return 'bg-violet-500/40 text-violet-200';
                        } else if (comp.status === 'High') {
                          return 'bg-emerald-500/30 text-emerald-300';
                        } else if (comp.status === 'Medium') {
                          return 'bg-amber-500/30 text-amber-300';
                        } else {
                          return 'bg-white/10 text-white/50';
                        }
                      })()
                    }`}>
                      üë•
                    </div>
                  </div>

                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-0.5">
                      <div className="text-[10px] font-bold uppercase tracking-[0.15em] text-white/50">
                        Social
                      </div>
                      <div className={`text-[10px] font-bold px-2 py-0.5 rounded ${
                        (() => {
                          const comp = personalizedCompatibility.social;
                          if (userCalibration.calibrated && userCalibration.energyColor === 'kinetic-green' && comp.status === 'High') {
                            return 'bg-cyan-500/40 text-cyan-200';
                          } else if (userCalibration.calibrated && userCalibration.energyColor === 'stillness-violet' && comp.status === 'High') {
                            return 'bg-violet-500/40 text-violet-200';
                          } else if (comp.status === 'High') {
                            return 'bg-emerald-500/30 text-emerald-300';
                          } else if (comp.status === 'Medium') {
                            return 'bg-amber-500/30 text-amber-300';
                          } else {
                            return 'bg-white/10 text-white/50';
                          }
                        })()
                      }`}>
                        {personalizedCompatibility.social.status}
                      </div>
                    </div>
                    <p className="text-xs text-white/80 leading-snug">
                      {personalizedCompatibility.social.note}
                    </p>
                  </div>
                </div>

                {/* Strategic */}
                <div className={`flex items-center gap-3 px-4 py-3 rounded-xl border transition-all duration-300 ${
                  (() => {
                    const comp = personalizedCompatibility.strategic;
                    const baseStyle = comp.status === 'High'
                      ? 'bg-emerald-500/10 border-emerald-500/30'
                      : comp.status === 'Medium'
                      ? 'bg-amber-500/10 border-amber-500/30'
                      : 'bg-white/5 border-white/10';

                    if (userCalibration.calibrated && userCalibration.energyColor && comp.status === 'High') {
                      if (userCalibration.energyColor === 'kinetic-green') {
                        return 'bg-gradient-to-r from-cyan-500/15 to-emerald-500/15 border border-cyan-400/50 shadow-[0_0_20px_rgba(34,211,238,0.25)]';
                      } else if (userCalibration.energyColor === 'stillness-violet') {
                        return 'bg-gradient-to-r from-violet-500/15 to-purple-500/15 border border-violet-400/50 shadow-[0_0_20px_rgba(139,92,246,0.25)]';
                      }
                    }
                    return baseStyle;
                  })()
                }`}>
                  <div className="flex-shrink-0">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold ${
                      (() => {
                        const comp = personalizedCompatibility.strategic;
                        if (userCalibration.calibrated && userCalibration.energyColor === 'kinetic-green' && comp.status === 'High') {
                          return 'bg-cyan-500/40 text-cyan-200';
                        } else if (userCalibration.calibrated && userCalibration.energyColor === 'stillness-violet' && comp.status === 'High') {
                          return 'bg-violet-500/40 text-violet-200';
                        } else if (comp.status === 'High') {
                          return 'bg-emerald-500/30 text-emerald-300';
                        } else if (comp.status === 'Medium') {
                          return 'bg-amber-500/30 text-amber-300';
                        } else {
                          return 'bg-white/10 text-white/50';
                        }
                      })()
                    }`}>
                      üéØ
                    </div>
                  </div>

                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-0.5">
                      <div className="text-[10px] font-bold uppercase tracking-[0.15em] text-white/50">
                        Strategic
                      </div>
                      <div className={`text-[10px] font-bold px-2 py-0.5 rounded ${
                        (() => {
                          const comp = personalizedCompatibility.strategic;
                          if (userCalibration.calibrated && userCalibration.energyColor === 'kinetic-green' && comp.status === 'High') {
                            return 'bg-cyan-500/40 text-cyan-200';
                          } else if (userCalibration.calibrated && userCalibration.energyColor === 'stillness-violet' && comp.status === 'High') {
                            return 'bg-violet-500/40 text-violet-200';
                          } else if (comp.status === 'High') {
                            return 'bg-emerald-500/30 text-emerald-300';
                          } else if (comp.status === 'Medium') {
                            return 'bg-amber-500/30 text-amber-300';
                          } else {
                            return 'bg-white/10 text-white/50';
                          }
                        })()
                      }`}>
                        {personalizedCompatibility.strategic.status}
                      </div>
                    </div>
                    <p className="text-xs text-white/80 leading-snug">
                      {personalizedCompatibility.strategic.note}
                    </p>
                  </div>
                </div>

                {/* Action */}
                <div className={`flex items-center gap-3 px-4 py-3 rounded-xl border transition-all duration-300 ${
                  (() => {
                    const comp = personalizedCompatibility.action;
                    const baseStyle = comp.status === 'High'
                      ? 'bg-emerald-500/10 border-emerald-500/30'
                      : comp.status === 'Medium'
                      ? 'bg-amber-500/10 border-amber-500/30'
                      : 'bg-white/5 border-white/10';

                    if (userCalibration.calibrated && userCalibration.energyColor && comp.status === 'High') {
                      if (userCalibration.energyColor === 'kinetic-green') {
                        return 'bg-gradient-to-r from-cyan-500/15 to-emerald-500/15 border border-cyan-400/50 shadow-[0_0_20px_rgba(34,211,238,0.25)]';
                      } else if (userCalibration.energyColor === 'stillness-violet') {
                        return 'bg-gradient-to-r from-violet-500/15 to-purple-500/15 border border-violet-400/50 shadow-[0_0_20px_rgba(139,92,246,0.25)]';
                      }
                    }
                    return baseStyle;
                  })()
                }`}>
                  <div className="flex-shrink-0">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold ${
                      (() => {
                        const comp = personalizedCompatibility.action;
                        if (userCalibration.calibrated && userCalibration.energyColor === 'kinetic-green' && comp.status === 'High') {
                          return 'bg-cyan-500/40 text-cyan-200';
                        } else if (userCalibration.calibrated && userCalibration.energyColor === 'stillness-violet' && comp.status === 'High') {
                          return 'bg-violet-500/40 text-violet-200';
                        } else if (comp.status === 'High') {
                          return 'bg-emerald-500/30 text-emerald-300';
                        } else if (comp.status === 'Medium') {
                          return 'bg-amber-500/30 text-amber-300';
                        } else {
                          return 'bg-white/10 text-white/50';
                        }
                      })()
                    }`}>
                      ‚ö°
                    </div>
                  </div>

                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-0.5">
                      <div className="text-[10px] font-bold uppercase tracking-[0.15em] text-white/50">
                        Action
                      </div>
                      <div className={`text-[10px] font-bold px-2 py-0.5 rounded ${
                        (() => {
                          const comp = personalizedCompatibility.action;
                          if (userCalibration.calibrated && userCalibration.energyColor === 'kinetic-green' && comp.status === 'High') {
                            return 'bg-cyan-500/40 text-cyan-200';
                          } else if (userCalibration.calibrated && userCalibration.energyColor === 'stillness-violet' && comp.status === 'High') {
                            return 'bg-violet-500/40 text-violet-200';
                          } else if (comp.status === 'High') {
                            return 'bg-emerald-500/30 text-emerald-300';
                          } else if (comp.status === 'Medium') {
                            return 'bg-amber-500/30 text-amber-300';
                          } else {
                            return 'bg-white/10 text-white/50';
                          }
                        })()
                      }`}>
                        {personalizedCompatibility.action.status}
                      </div>
                    </div>
                    <p className="text-xs text-white/80 leading-snug">
                      {personalizedCompatibility.action.note}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* PERSONAL CALIBRATION - Moved to Bottom */}
        <div className="w-full">
          <div className="backdrop-blur-xl bg-white/5 border border-white/10 rounded-2xl p-6 shadow-2xl">
            <ResonanceCompass onCalibrated={handleCalibrated} />
          </div>
        </div>
      </main>

      {/* Result card */}
      <AtomicCard
        open={cardOpen}
        status={cardData.status}
        oracle={cardData.oracle}
        supported={cardData.supported}
        adjustment={cardData.adjustment}
        disclaimer={cardData.disclaimer}
        hexagram={cardData.hexagram}
        l2_interpretation={cardData.l2_interpretation}
        onClose={() => setCardOpen(false)}
      />
    </div>
  );
}
